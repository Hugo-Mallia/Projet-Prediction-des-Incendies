<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit de Prévention des Incendies</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        #auditResult {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>Audit de Prévention des Incendies</h1>
    <div style="display: flex; gap: 20px;">
        <!-- Formulaire -->
        <form id="auditForm" style="flex: 1;">
            <label for="buildingName">Nom du bâtiment :</label>
            <input type="text" id="buildingName" name="buildingName" required><br><br>

            <label for="fireExtinguishers">Nombre d'extincteurs :</label>
            <input type="number" id="fireExtinguishers" name="fireExtinguishers" required><br><br>

            <label for="emergencyExits">Nombre de sorties de secours :</label>
            <input type="number" id="emergencyExits" name="emergencyExits" required><br><br>

            <label for="smokeDetectors">Nombre de détecteurs de fumée :</label>
            <input type="number" id="smokeDetectors" name="smokeDetectors" required><br><br>

            <label for="buildingSize">Taille du bâtiment (en m²) :</label>
            <input type="number" id="buildingSize" name="buildingSize" required><br><br>

            <label for="buildingType">Type de bâtiment :</label>
            <select id="buildingType" name="buildingType" required>
                <option value="immeuble">Immeuble</option>
                <option value="maison">Maison</option>
                <option value="entrepot">Entrepôt</option>
                <option value="usine">Usine</option>
                <option value="etablissement_public">Établissement recevant du public</option>
            </select><br><br>

            <label for="buildingUsage">Usage du bâtiment :</label>
            <select id="buildingUsage" name="buildingUsage" required>
                <option value="professionnel">Professionnel</option>
                <option value="personnel">Personnel</option>
            </select><br><br>

            <label for="roomCount">Nombre de pièces dans le bâtiment :</label>
            <input type="number" id="roomCount" name="roomCount" required><br><br>

            <label for="roomSizes">Taille de chaque pièce (en m², séparées par des virgules) :</label>
            <input type="text" id="roomSizes" name="roomSizes" placeholder="Exemple : 20, 15, 30" required><br><br>

            <button type="button" onclick="submitAudit()">Soumettre l'Audit</button>
        </form>

        <!-- Compte rendu -->
        <div id="auditResult" style="flex: 1; display: none;">
            <h2>Compte Rendu de votre Audit</h2>
            <p id="auditMessage"></p>
        </div>
    </div>

    <!-- Bouton Retour -->
    <div style="margin-top: 20px;">
        <button onclick="window.location.href='/'">Retour à la page d'accueil</button>
    </div>

    <script>
        async function submitAudit() {
            const formData = new FormData(document.getElementById("auditForm"));

            try {
                const response = await fetch("/api/submit-audit", {
                    method: "POST",
                    body: formData,
                });

                const result = await response.json();

                // Générer les recommandations
                let recommendations = "";
                if (result.status === "Non conforme") {
                    recommendations = `
                        <h3>Recommandations :</h3>
                        <ul>
                            <li>Vérifiez le nombre d'extincteurs et ajoutez-en si nécessaire.</li>
                            <li>Assurez-vous d'avoir au moins deux sorties de secours accessibles.</li>
                            <li>Installez des détecteurs de fumée dans toutes les pièces.</li>
                            <li>Réduisez la taille des pièces dépassant 50 m² ou divisez-les.</li>
                        </ul>
                    `;
                }

                // Afficher le compte rendu
                const auditMessage = `
                    <strong>Status :</strong> ${result.status}<br>
                    <strong>Message :</strong> ${result.message}<br><br>
                    <strong>Résumé des informations saisies :</strong><br>
                    <strong>Nom du bâtiment :</strong> ${result.data.buildingName}<br>
                    <strong>Nombre d'extincteurs :</strong> ${result.data.fireExtinguishers}<br>
                    <strong>Nombre de sorties de secours :</strong> ${result.data.emergencyExits}<br>
                    <strong>Nombre de détecteurs de fumée :</strong> ${result.data.smokeDetectors}<br>
                    <strong>Taille du bâtiment :</strong> ${result.data.buildingSize} m²<br>
                    <strong>Nombre de pièces :</strong> ${result.data.roomCount}<br>
                    <strong>Tailles des pièces :</strong> ${result.data.roomSizes.join(", ")} m²<br>
                    <strong>Données des capeurs :</strong> <br>    - Température : ${result.data.automatedData.temperature}°C, <br>    - Niveau de fumée : ${result.data.automatedData.smoke_level}, <br>    - Statut des extincteurs : ${result.data.automatedData.fire_extinguisher_status}<br>
                    ${recommendations}
                `;
                document.getElementById("auditMessage").innerHTML = auditMessage;
                document.getElementById("auditResult").style.display = "block";
            } catch (error) {
                console.error("Erreur lors de l'envoi de l'audit :", error);
                alert("Une erreur est survenue lors de l'envoi de l'audit.");
            }
        }
    </script>
</body>
</html>